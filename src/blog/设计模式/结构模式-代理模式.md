---
icon: document
# 标题
title: '结构模式-代理模式'
# 设置作者
author: Ms.Zyh
# 设置写作时间
date: 2022-05-19
# 一个页面可以有多个分类
category:
  - 设计模式
# 一个页面可以有多个标签
tag:
  - 必看
  - 设计模式
# 此页面会在文章列表置顶
sticky: false
# 此页面会出现在星标文章中
star: false
---

#### 一，静态代理
在开发中，通常需要为方法添加日志打印，能够记录程序的执行过程，以便后续出现异常问题的时候，能更好的排查定位。假设我们现在已经完成了系统用户的增加、删除、修改等功能，这些功能在类UserServiceImpl中已经实现。
```java
public interface UserService {
    void add();
    void update();
    void delete();
} 
public class UserServiceImpl  implements UserService{
    public void add() {
        System.out.println("添加用户");
    }

    public void update() {
        System.out.println("修改用户");
    }

    public void delete() {
        System.out.println("删除用户");
    }
}
```
现在，我们需要在UserServiceImpl类中的方法添加日志功能，那么怎么才能更好地去实现这个需求呢？
方式一：直接在目标方法前后添加日志代码
```java
public class UserServiceImpl implements UserService{
    public void add() {
        System.out.println("====== add方法开始 ======");
        System.out.println("添加用户");
        System.out.println("====== add方法结束 ======");
    }

    public void update() {
        System.out.println("====== update方法开始 ======");
        System.out.println("修改用户");
        System.out.println("====== update方法结束 ======");
    }

    public void delete() {
        System.out.println("====== delete方法开始 ======");
        System.out.println("删除用户");
        System.out.println("====== delete方法结束 ======");
    }
}
```
这种方式的缺点在于：
- 如果UserServiceImpl类中，有很多的方法，修改量大，且存在大量重复代码，不利于后期维护。
- 直接修改源代码，不符号开闭原则。应该对扩展开放，对修改关闭。

方式二：静态代理方式实现
静态代理需要我们将目标类的方法抽取到接口中，代理类和目标类实现同一个接口，既然要实现代理，代理类自然需要在其内部维护目标对象的引用，并通过构造函数为其赋值，然后在代理类的方法中调用目标对象的同名方法，并在调用前后完成功能的增强。
``` java
// 目标接口
public interface UserService {
    void add();
    void update();
    void delete();
}
// 目标类
public class UserServiceImpl implements UserService {
    @Override
    public void add() {
        System.out.println("添加用户");
    }

    @Override
    public void update() {
        System.out.println("修改用户");
    }

    @Override
    public void delete() {
        System.out.println("删除用户");
    }
}
// 代理类
public class UserServiceProxy implements UserService {

    private UserService userService;

    public UserServiceProxy(UserService userService) {
        this.userService = userService;
    }

    @Override
    public void add() {
        System.out.println("====== add方法开始 ======");
        userService.add();
        System.out.println("====== add方法结束 ======");
    }

    @Override
    public void update() {
        System.out.println("====== update方法开始 ======");
        userService.update();
        System.out.println("====== update方法结束 ======");
    }

    @Override
    public void delete() {
        System.out.println("====== delete方法开始 ======");
        userService.delete();
        System.out.println("====== delete方法结束 ======");
    }
}
```
静态代理遵循开闭原则，在不修改目标类的前提下，完成了功能的增强，但是依然存在大量重复的代码，且一个代理类只能代理一个目标类，如果有n个目标类需要被代理，就需要同比增加n个代理类。
那么，有没有办法可以使得我们不需要去定义这么多的代理类，就可以实现对目标类功能的增强？答案是有的：动态代理

#### 二，jdk动态代理
首先我们先思考一个问题，接口不能直接new，也没有构造方法，并且不存在代理类的class文件，怎么获得Class对象了，没有Class对象我们怎么创建实例对象？
这个时候就要请出我们的重量级选手Proxy类：
![image.png](http://img.zouyh.top/article-img/20240917135131394.png)
Proxy类为我们提供了四个静态方法，我们先看`public static Class<?> getProxyClass(ClassLoader loader,Class<?>... interfaces)`方法的作用：
定义一个接口：
```java
public interface UserService {
    void add();
    void update();
    void delete();
}
```
测试Proxy的getProxyClass方法：
```java
public class Test {
    public static void main(String[] args) {
        Class<?> proxyClass = Proxy.getProxyClass(Test.class.getClassLoader(), UserService.class);
        System.out.println(proxyClass.getName());
	System.out.println(Arrays.toString(proxyClass.getInterfaces()));
	System.out.println(Arrays.toString(proxyClass.getConstructors()));
    }
}
```
输出结果：
```
com.sun.proxy.$Proxy0
[interface top.zouyh.test.UserService]
[public com.sun.proxy.$Proxy0(java.lang.reflect.InvocationHandler)]
```
结果分析：
通过Proxy的getProxyClass方法，我们只需要传入ClassLoader和一个接口Class，就可以获取到一个代理类`com.sun.proxy.$Proxy0`，并且这个代理对象是实现该接口的。到这里我们算是解决了接口不能直接new，也没有构造方法，并且不存在代理类的class文件的问题，并且从输出的结果我们还可以看出代理类，虽然没有提供无产构造，但是提供了传递`java.lang.reflect.InvocationHandler`参数的构造方法。

接下来测试代理类的构造方法：
```java
public class Test {
    public static void main(String[] args) throws Exception {
        Class<?> proxyClass = Proxy.getProxyClass(Test.class.getClassLoader(), UserService.class);
        System.out.println(proxyClass.getName());
        System.out.println(Arrays.toString(proxyClass.getInterfaces()));
        System.out.println(Arrays.toString(proxyClass.getConstructors()));
        // 获取InvocationHandler参数的构造函数
        Constructor<?> constructor = proxyClass.getConstructor(InvocationHandler.class);
        // 调用构造参数，并传入InvocationHandler参数，获取实例对象
        UserService object = (UserService)constructor.newInstance(new InvocationHandler() {
            @Override
            public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                System.out.println("proxy:" + proxy.getClass().getName());
                System.out.println("method:" + method.getName());
                return null;
            }
        });
        // 调用方法
        object.add();
    }
}
```
输出结果：
```
com.sun.proxy.$Proxy0
[interface top.zouyh.test.UserService]
[public com.sun.proxy.$Proxy0(java.lang.reflect.InvocationHandler)]
proxy:com.sun.proxy.$Proxy0
method:add
```
从输出结果我们可以看出，当我们获得代理对象之后，通过代理对象来调用接口方法，都会回调构造时传进来的InvocationHandler对象的`invoke(Object proxy, Method method, Object[] args)`方法，该方法有3个参数：
- `Object proxy`：是代理对象本身。
- `Method method`：是被调用的方法的Method对象。
- `Object[] args`：是被调用方法的参数

接下来查看一下生成的代理类的class文件，添加如下代码即可
```java
System.setProperty("sun.misc.ProxyGenerator.saveGeneratedFiles", "true");
```
例如：
```java
public class Test {
    public static void main(String[] args) throws Exception {
        System.setProperty("sun.misc.ProxyGenerator.saveGeneratedFiles", "true");
        Class<?> proxyClass = Proxy.getProxyClass(Test.class.getClassLoader(), UserService.class);     
    }
}

```
生成的class文件所在：项目名称/com/sun/proxy/$Proxy0.class
```java
//
// Source code recreated from a .class file by IntelliJ IDEA
// (powered by FernFlower decompiler)
//

package com.sun.proxy;

import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;
import java.lang.reflect.Proxy;
import java.lang.reflect.UndeclaredThrowableException;
import org.example.test06.UserService;

public final class $Proxy0 extends Proxy implements UserService {
    private static Method m1;
    private static Method m2;
    private static Method m3;
    private static Method m5;
    private static Method m0;
    private static Method m4;

    public $Proxy0(InvocationHandler var1) throws  {
        super(var1);
    }

    public final boolean equals(Object var1) throws  {
        try {
            return (Boolean)super.h.invoke(this, m1, new Object[]{var1});
        } catch (RuntimeException | Error var3) {
            throw var3;
        } catch (Throwable var4) {
            throw new UndeclaredThrowableException(var4);
        }
    }

    public final String toString() throws  {
        try {
            return (String)super.h.invoke(this, m2, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    public final void add() throws  {
        try {
            super.h.invoke(this, m3, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    public final void delete() throws  {
        try {
            super.h.invoke(this, m5, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    public final int hashCode() throws  {
        try {
            return (Integer)super.h.invoke(this, m0, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    public final void update() throws  {
        try {
            super.h.invoke(this, m4, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    static {
        try {
            m1 = Class.forName("java.lang.Object").getMethod("equals", Class.forName("java.lang.Object"));
            m2 = Class.forName("java.lang.Object").getMethod("toString");
            m3 = Class.forName("top.zouyh.test.UserService").getMethod("add");
            m5 = Class.forName("top.zouyh.test.UserService").getMethod("delete");
            m0 = Class.forName("java.lang.Object").getMethod("hashCode");
            m4 = Class.forName("top.zouyh.test.UserService").getMethod("update");
        } catch (NoSuchMethodException var2) {
            throw new NoSuchMethodError(var2.getMessage());
        } catch (ClassNotFoundException var3) {
            throw new NoClassDefFoundError(var3.getMessage());
        }
    }
}

```
以add方法调用为例，会调用到super.h.invoke方法super.h是什么是Proxy的成员变量InvocationHandler
```java
public class Proxy implements java.io.Serializable {
    private static final long serialVersionUID = -2222568056686623797L;
    private Proxy() {
    }
    protected Proxy(InvocationHandler h) {
        Objects.requireNonNull(h);
        this.h = h;
    }
```
结合$Proxy0.class中的构造方法可以看出，方法的增强是通过InvocationHandler的invoke方法来实现。
最后我们一般不直接使用Proxy.getProxyClass方法获取到Class对象后，在获取构造方法去创建代理对象，而是使用Proxy.newProxyInstance方法如下：
```java
// UserService接口
public interface UserService {
    void add();
    void update();
    void delete();
}

// 目标类
public class UserServiceImpl implements UserService {
    @Override
    public void add() {
        System.out.println("添加用户");
    }

    @Override
    public void update() {
        System.out.println("修改用户");
    }

    @Override
    public void delete() {
        System.out.println("删除用户");
    }
}

// 自定义InvocationHandler
public class CustomInvocationHandler implements InvocationHandler {

    // 目标对象
    private Object target;

    public CustomInvocationHandler(Object target) {
        this.target = target;
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        System.out.println("====== 方法开始 ======");
	// 注意这里是target目标对象，不是proxy代理对象，如果是代理对象就会递归调用进入死循环
        Object result = method.invoke(target, args);
        System.out.println("====== 方法结束 ======");
        return result;
    }
}
```
测试：
```java
public class Test {
    public static void main(String[] args) throws Exception {
        UserService target = new UserServiceImpl();
        UserService proxy = (UserService)Proxy.newProxyInstance(Test.class.getClassLoader(),
                new Class[]{UserService.class},
                new CustomInvocationHandler(target));
        proxy.add();
    }
}
```
输出结果：
```
====== 方法开始 ======
添加用户
====== 方法结束 ======
```

#### 三，cglib动态代理
CGLIB是一个强大的、高性能、高质量的代码生成类库，它可以在运行期扩展Java类与实现:
```xml
<dependency>
    <groupId>cglib</groupId>
    <artifactId>cglib</artifactId>
    <version>3.3.0</version>
</dependency>
```
示例：
```java

// 目标类
public class UserServiceImpl {

    public void add() {
        System.out.println("添加用户");
    }

    public void update() {
        System.out.println("修改用户");
    }

    public void delete() {
        System.out.println("删除用户");
    }
}
// 自定义方法拦截
public class CustomInvocationHandler implements MethodInterceptor {
    @Override
    public Object intercept(Object object, Method method, Object[] args, MethodProxy methodProxy) throws Throwable {
        System.out.println("====== 方法开始 ======");
	System.out.println("Object:"+object.getClass());
        System.out.println("method:"+method.getName());
        System.out.println("methodProxy:"+methodProxy.getSuperName());
        Object result = methodProxy.invokeSuper(object, args);
        System.out.println("====== 方法结束 ======");
        return result;
    }
}

```
测试
```
public class Test {
    public static void main(String[] args) throws Exception {
        // 在创建代理之前执行，可以在创建代理对象的时候，在项目文件夹下生成代理对象的class文件
	System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, "./cglib");
	Enhancer enhancer = new Enhancer();
	enhancer.setSuperclass(UserServiceImpl.class);
	enhancer.setCallback(new CustomInvocationHandler());
	UserServiceImpl object = (UserServiceImpl)enhancer.create();
	object.add();
	System.out.println(object.getClass());

    }
}

```
输出结果：
```
====== 方法开始 ======
object:class top.zou.UserServiceImpl$$EnhancerByCGLIB$$7d030b4a
method:add
methodProxy:CGLIB$add$0
添加用户
====== 方法结束 ======
class top.zou.UserServiceImpl$$EnhancerByCGLIB$$7d030b4a
```
从运行结果可以看出，在目标方法的前后，执行了自定义的操作，代理类是`UserServiceImpl$$EnhancerByCGLIB$$7d030b4a`调用`top.zou.UserServiceImpl$$EnhancerByCGLIB$$7d030b4a`的add方法：
再看看生成的class文件：
![image.png](http://img.zouyh.top/article-img/20240917135128393.png)
可以看到一共生成了5个类，先看调用`top.zou.UserServiceImpl$$EnhancerByCGLIB$$7d030b4a`的add方法：
```java

public class UserServiceImpl$$EnhancerByCGLIB$$7d030b4a extends UserServiceImpl implements Factory {
    private boolean CGLIB$BOUND;
    public static Object CGLIB$FACTORY_DATA;
    private static final ThreadLocal CGLIB$THREAD_CALLBACKS;
    private static final Callback[] CGLIB$STATIC_CALLBACKS;
    private MethodInterceptor CGLIB$CALLBACK_0;
    private static Object CGLIB$CALLBACK_FILTER;
    private static final Method CGLIB$add$0$Method;
    private static final MethodProxy CGLIB$add$0$Proxy;
    private static final Object[] CGLIB$emptyArgs;
    private static final Method CGLIB$update$1$Method;
    private static final MethodProxy CGLIB$update$1$Proxy;
    private static final Method CGLIB$delete$2$Method;
    private static final MethodProxy CGLIB$delete$2$Proxy;
    private static final Method CGLIB$equals$3$Method;
    private static final MethodProxy CGLIB$equals$3$Proxy;
    private static final Method CGLIB$toString$4$Method;
    private static final MethodProxy CGLIB$toString$4$Proxy;
    private static final Method CGLIB$hashCode$5$Method;
    private static final MethodProxy CGLIB$hashCode$5$Proxy;
    private static final Method CGLIB$clone$6$Method;
    private static final MethodProxy CGLIB$clone$6$Proxy;

    static void CGLIB$STATICHOOK1() {
        CGLIB$THREAD_CALLBACKS = new ThreadLocal();
        CGLIB$emptyArgs = new Object[0];
        Class var0 = Class.forName("top.zouyh.UserServiceImpl$$EnhancerByCGLIB$$7d030b4a");
        Class var1;
        Method[] var10000 = ReflectUtils.findMethods(new String[]{"equals", "(Ljava/lang/Object;)Z", "toString", "()Ljava/lang/String;", "hashCode", "()I", "clone", "()Ljava/lang/Object;"}, (var1 = Class.forName("java.lang.Object")).getDeclaredMethods());
        CGLIB$equals$3$Method = var10000[0];
        CGLIB$equals$3$Proxy = MethodProxy.create(var1, var0, "(Ljava/lang/Object;)Z", "equals", "CGLIB$equals$3");
        CGLIB$toString$4$Method = var10000[1];
        CGLIB$toString$4$Proxy = MethodProxy.create(var1, var0, "()Ljava/lang/String;", "toString", "CGLIB$toString$4");
        CGLIB$hashCode$5$Method = var10000[2];
        CGLIB$hashCode$5$Proxy = MethodProxy.create(var1, var0, "()I", "hashCode", "CGLIB$hashCode$5");
        CGLIB$clone$6$Method = var10000[3];
        CGLIB$clone$6$Proxy = MethodProxy.create(var1, var0, "()Ljava/lang/Object;", "clone", "CGLIB$clone$6");
        var10000 = ReflectUtils.findMethods(new String[]{"add", "()V", "update", "()V", "delete", "()V"}, (var1 = Class.forName("top.zouyh.UserServiceImpl")).getDeclaredMethods());
        CGLIB$add$0$Method = var10000[0];
        CGLIB$add$0$Proxy = MethodProxy.create(var1, var0, "()V", "add", "CGLIB$add$0");
        CGLIB$update$1$Method = var10000[1];
        CGLIB$update$1$Proxy = MethodProxy.create(var1, var0, "()V", "update", "CGLIB$update$1");
        CGLIB$delete$2$Method = var10000[2];
        CGLIB$delete$2$Proxy = MethodProxy.create(var1, var0, "()V", "delete", "CGLIB$delete$2");
    }

    final void CGLIB$add$0() {
        super.add();
    }

    public final void add() {
        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;
        if (var10000 == null) {
            CGLIB$BIND_CALLBACKS(this);
            var10000 = this.CGLIB$CALLBACK_0;
        }

        if (var10000 != null) {
            var10000.intercept(this, CGLIB$add$0$Method, CGLIB$emptyArgs, CGLIB$add$0$Proxy);
        } else {
            super.add();
        }
    }

    final void CGLIB$update$1() {
        super.update();
    }

    public final void update() {
        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;
        if (var10000 == null) {
            CGLIB$BIND_CALLBACKS(this);
            var10000 = this.CGLIB$CALLBACK_0;
        }

        if (var10000 != null) {
            var10000.intercept(this, CGLIB$update$1$Method, CGLIB$emptyArgs, CGLIB$update$1$Proxy);
        } else {
            super.update();
        }
    }

    final void CGLIB$delete$2() {
        super.delete();
    }

    public final void delete() {
        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;
        if (var10000 == null) {
            CGLIB$BIND_CALLBACKS(this);
            var10000 = this.CGLIB$CALLBACK_0;
        }

        if (var10000 != null) {
            var10000.intercept(this, CGLIB$delete$2$Method, CGLIB$emptyArgs, CGLIB$delete$2$Proxy);
        } else {
            super.delete();
        }
    }

    final boolean CGLIB$equals$3(Object var1) {
        return super.equals(var1);
    }

    public final boolean equals(Object var1) {
        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;
        if (var10000 == null) {
            CGLIB$BIND_CALLBACKS(this);
            var10000 = this.CGLIB$CALLBACK_0;
        }

        if (var10000 != null) {
            Object var2 = var10000.intercept(this, CGLIB$equals$3$Method, new Object[]{var1}, CGLIB$equals$3$Proxy);
            return var2 == null ? false : (Boolean)var2;
        } else {
            return super.equals(var1);
        }
    }

    final String CGLIB$toString$4() {
        return super.toString();
    }

    public final String toString() {
        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;
        if (var10000 == null) {
            CGLIB$BIND_CALLBACKS(this);
            var10000 = this.CGLIB$CALLBACK_0;
        }

        return var10000 != null ? (String)var10000.intercept(this, CGLIB$toString$4$Method, CGLIB$emptyArgs, CGLIB$toString$4$Proxy) : super.toString();
    }

    final int CGLIB$hashCode$5() {
        return super.hashCode();
    }

    public final int hashCode() {
        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;
        if (var10000 == null) {
            CGLIB$BIND_CALLBACKS(this);
            var10000 = this.CGLIB$CALLBACK_0;
        }

        if (var10000 != null) {
            Object var1 = var10000.intercept(this, CGLIB$hashCode$5$Method, CGLIB$emptyArgs, CGLIB$hashCode$5$Proxy);
            return var1 == null ? 0 : ((Number)var1).intValue();
        } else {
            return super.hashCode();
        }
    }

    final Object CGLIB$clone$6() throws CloneNotSupportedException {
        return super.clone();
    }

    protected final Object clone() throws CloneNotSupportedException {
        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;
        if (var10000 == null) {
            CGLIB$BIND_CALLBACKS(this);
            var10000 = this.CGLIB$CALLBACK_0;
        }

        return var10000 != null ? var10000.intercept(this, CGLIB$clone$6$Method, CGLIB$emptyArgs, CGLIB$clone$6$Proxy) : super.clone();
    }

    public static MethodProxy CGLIB$findMethodProxy(Signature var0) {
        String var10000 = var0.toString();
        switch (var10000.hashCode()) {
            case -1949253108:
                if (var10000.equals("update()V")) {
                    return CGLIB$update$1$Proxy;
                }
                break;
            case -1422568652:
                if (var10000.equals("add()V")) {
                    return CGLIB$add$0$Proxy;
                }
                break;
            case -508378822:
                if (var10000.equals("clone()Ljava/lang/Object;")) {
                    return CGLIB$clone$6$Proxy;
                }
                break;
            case -358764054:
                if (var10000.equals("delete()V")) {
                    return CGLIB$delete$2$Proxy;
                }
                break;
            case 1826985398:
                if (var10000.equals("equals(Ljava/lang/Object;)Z")) {
                    return CGLIB$equals$3$Proxy;
                }
                break;
            case 1913648695:
                if (var10000.equals("toString()Ljava/lang/String;")) {
                    return CGLIB$toString$4$Proxy;
                }
                break;
            case 1984935277:
                if (var10000.equals("hashCode()I")) {
                    return CGLIB$hashCode$5$Proxy;
                }
        }

        return null;
    }

    public UserServiceImpl$$EnhancerByCGLIB$$7d030b4a() {
        CGLIB$BIND_CALLBACKS(this);
    }

    public static void CGLIB$SET_THREAD_CALLBACKS(Callback[] var0) {
        CGLIB$THREAD_CALLBACKS.set(var0);
    }

    public static void CGLIB$SET_STATIC_CALLBACKS(Callback[] var0) {
        CGLIB$STATIC_CALLBACKS = var0;
    }

    private static final void CGLIB$BIND_CALLBACKS(Object var0) {
        UserServiceImpl$$EnhancerByCGLIB$$7d030b4a var1 = (UserServiceImpl$$EnhancerByCGLIB$$7d030b4a)var0;
        if (!var1.CGLIB$BOUND) {
            var1.CGLIB$BOUND = true;
            Object var10000 = CGLIB$THREAD_CALLBACKS.get();
            if (var10000 == null) {
                var10000 = CGLIB$STATIC_CALLBACKS;
                if (var10000 == null) {
                    return;
                }
            }

            var1.CGLIB$CALLBACK_0 = (MethodInterceptor)((Callback[])var10000)[0];
        }

    }

    public Object newInstance(Callback[] var1) {
        CGLIB$SET_THREAD_CALLBACKS(var1);
        UserServiceImpl$$EnhancerByCGLIB$$7d030b4a var10000 = new UserServiceImpl$$EnhancerByCGLIB$$7d030b4a();
        CGLIB$SET_THREAD_CALLBACKS((Callback[])null);
        return var10000;
    }

    public Object newInstance(Callback var1) {
        CGLIB$SET_THREAD_CALLBACKS(new Callback[]{var1});
        UserServiceImpl$$EnhancerByCGLIB$$7d030b4a var10000 = new UserServiceImpl$$EnhancerByCGLIB$$7d030b4a();
        CGLIB$SET_THREAD_CALLBACKS((Callback[])null);
        return var10000;
    }

    public Object newInstance(Class[] var1, Object[] var2, Callback[] var3) {
        CGLIB$SET_THREAD_CALLBACKS(var3);
        UserServiceImpl$$EnhancerByCGLIB$$7d030b4a var10000 = new UserServiceImpl$$EnhancerByCGLIB$$7d030b4a;
        switch (var1.length) {
            case 0:
                var10000.<init>();
                CGLIB$SET_THREAD_CALLBACKS((Callback[])null);
                return var10000;
            default:
                throw new IllegalArgumentException("Constructor not found");
        }
    }

    public Callback getCallback(int var1) {
        CGLIB$BIND_CALLBACKS(this);
        MethodInterceptor var10000;
        switch (var1) {
            case 0:
                var10000 = this.CGLIB$CALLBACK_0;
                break;
            default:
                var10000 = null;
        }

        return var10000;
    }

    public void setCallback(int var1, Callback var2) {
        switch (var1) {
            case 0:
                this.CGLIB$CALLBACK_0 = (MethodInterceptor)var2;
            default:
        }
    }

    public Callback[] getCallbacks() {
        CGLIB$BIND_CALLBACKS(this);
        return new Callback[]{this.CGLIB$CALLBACK_0};
    }

    public void setCallbacks(Callback[] var1) {
        this.CGLIB$CALLBACK_0 = (MethodInterceptor)var1[0];
    }

    static {
        CGLIB$STATICHOOK1();
    }
}

```
可以看出top.zou.UserServiceImpl$$EnhancerByCGLIB$$7d030b4a继承了UserServiceImpl类（也就是说自动生成的代理类其实是被代理类的一个子类），并且重写了UserServiceImpl类的add()方法，重写后的add()方法会调用自定义的方法拦截器MethodInterceptor（这里是CustomInvocationHandler）的intercept()方法：
```java
// 自定义方法拦截
public class CustomInvocationHandler implements MethodInterceptor {
    @Override
    public Object intercept(Object object, Method method, Object[] args, MethodProxy methodProxy) throws Throwable {
        System.out.println("====== 方法开始 ======");
        System.out.println("method:"+method.getName());
        System.out.println("methodProxy:"+methodProxy.getSuperName());
        Object result = methodProxy.invokeSuper(object, args);
        System.out.println("====== 方法结束 ======");
        return result;
    }
}
```
MethodProxy的invokeSuper方法：
``` java
public Object invokeSuper(Object obj, Object[] args) throws Throwable {
    try {
        this.init();
        FastClassInfo fci = this.fastClassInfo;
	//fci.f2是UserServiceImpl$$EnhancerByCGLIB$$7d030b4a$$FastClassByCGLIB$$46fa6803
        return fci.f2.invoke(fci.i2, obj, args);
    } catch (InvocationTargetException var4) {
        throw var4.getTargetException();
    }
}

```
看看`this.init();`方法：
```java
private void init() {
    if (this.fastClassInfo == null) {
        synchronized(this.initLock) {
            if (this.fastClassInfo == null) {
                CreateInfo ci = this.createInfo;
                FastClassInfo fci = new FastClassInfo();
		// 索引类UserServiceImpl$$FastClassByCGLIB$$3522ecb2
                fci.f1 = helper(ci, ci.c1);
               // 索引类UserServiceImpl$$EnhancerByCGLIB$$7d030b4a$$FastClassByCGLIB$$46fa6803
                fci.f2 = helper(ci, ci.c2);
                // 其实执行的是的UserServiceImpl$$FastClassByCGLIB$$3522ecb2的getIndex()方法
                fci.i1 = fci.f1.getIndex(this.sig1);
                // 其实执行的是的UserServiceImpl$$EnhancerByCGLIB$$7d030b4a$$FastClassByCGLIB$$46fa6803的getIndex()方法
                fci.i2 = fci.f2.getIndex(this.sig2);
                this.fastClassInfo = fci;
                this.createInfo = null;
            }
        }
    }

}

```
 在看UserServiceImpl$$FastClassByCGLIB$$3522ecb2方法
```java
public class UserServiceImpl$$FastClassByCGLIB$$3522ecb2 extends FastClass {
    public UserServiceImpl$$FastClassByCGLIB$$3522ecb2(Class var1) {
        super(var1);
    }

    public int getIndex(Signature var1) {
        String var10000 = var1.toString();
        switch (var10000.hashCode()) {
            case -1949253108:
                if (var10000.equals("update()V")) {
                    return 1;
                }
                break;
            case -1422568652:
                if (var10000.equals("add()V")) {
                    return 0;
                }
                break;
            case -358764054:
                if (var10000.equals("delete()V")) {
                    return 2;
                }
                break;
            case 1826985398:
                if (var10000.equals("equals(Ljava/lang/Object;)Z")) {
                    return 3;
                }
                break;
            case 1913648695:
                if (var10000.equals("toString()Ljava/lang/String;")) {
                    return 4;
                }
                break;
            case 1984935277:
                if (var10000.equals("hashCode()I")) {
                    return 5;
                }
        }

        return -1;
    }

    public int getIndex(String var1, Class[] var2) {
        switch (var1.hashCode()) {
            case -1776922004:
                if (var1.equals("toString")) {
                    switch (var2.length) {
                        case 0:
                            return 4;
                    }
                }
                break;
            case -1335458389:
                if (var1.equals("delete")) {
                    switch (var2.length) {
                        case 0:
                            return 2;
                    }
                }
                break;
            case -1295482945:
                if (var1.equals("equals")) {
                    switch (var2.length) {
                        case 1:
                            if (var2[0].getName().equals("java.lang.Object")) {
                                return 3;
                            }
                    }
                }
                break;
            case -838846263:
                if (var1.equals("update")) {
                    switch (var2.length) {
                        case 0:
                            return 1;
                    }
                }
                break;
            case 96417:
                if (var1.equals("add")) {
                    switch (var2.length) {
                        case 0:
                            return 0;
                    }
                }
                break;
            case 147696667:
                if (var1.equals("hashCode")) {
                    switch (var2.length) {
                        case 0:
                            return 5;
                    }
                }
        }

        return -1;
    }

    public int getIndex(Class[] var1) {
        switch (var1.length) {
            case 0:
                return 0;
            default:
                return -1;
        }
    }

    public Object invoke(int var1, Object var2, Object[] var3) throws InvocationTargetException {
        UserServiceImpl var10000 = (UserServiceImpl)var2;
        int var10001 = var1;

        try {
            switch (var10001) {
                case 0:
                    var10000.add();
                    return null;
                case 1:
                    var10000.update();
                    return null;
                case 2:
                    var10000.delete();
                    return null;
                case 3:
                    return new Boolean(var10000.equals(var3[0]));
                case 4:
                    return var10000.toString();
                case 5:
                    return new Integer(var10000.hashCode());
            }
        } catch (Throwable var4) {
            throw new InvocationTargetException(var4);
        }

        throw new IllegalArgumentException("Cannot find matching method/constructor");
    }

    public Object newInstance(int var1, Object[] var2) throws InvocationTargetException {
        UserServiceImpl var10000 = new UserServiceImpl;
        UserServiceImpl var10001 = var10000;
        int var10002 = var1;

        try {
            switch (var10002) {
                case 0:
                    var10001.<init>();
                    return var10000;
            }
        } catch (Throwable var3) {
            throw new InvocationTargetException(var3);
        }

        throw new IllegalArgumentException("Cannot find matching method/constructor");
    }

    public int getMaxIndex() {
        return 5;
    }
}

```
在看`UserServiceImpl$$EnhancerByCGLIB$$7d030b4a$$FastClassByCGLIB$$46fa6803`类，从名称上可以看出这个类的前半段是我们刚看的class，后半段拼接上了$$FastClassByCGLIB$$46fa6803
```java
public class UserServiceImpl$$EnhancerByCGLIB$$7d030b4a$$FastClassByCGLIB$$46fa6803 extends FastClass {
    public UserServiceImpl$$EnhancerByCGLIB$$7d030b4a$$FastClassByCGLIB$$46fa6803(Class var1) {
        super(var1);
    }

    public int getIndex(Signature var1) {
        String var10000 = var1.toString();
        switch (var10000.hashCode()) {
            case -2071771415:
                if (var10000.equals("CGLIB$clone$6()Ljava/lang/Object;")) {
                    return 14;
                }
                break;
            case -2055565910:
                if (var10000.equals("CGLIB$SET_THREAD_CALLBACKS([Lnet/sf/cglib/proxy/Callback;)V")) {
                    return 1;
                }
                break;
            case -1998788309:
                if (var10000.equals("CGLIB$add$0()V")) {
                    return 8;
                }
                break;
            case -1949253108:
                if (var10000.equals("update()V")) {
                    return 20;
                }
                break;
            case -1663710620:
                if (var10000.equals("CGLIB$equals$3(Ljava/lang/Object;)Z")) {
                    return 11;
                }
                break;
            case -1457535688:
                if (var10000.equals("CGLIB$STATICHOOK1()V")) {
                    return 7;
                }
                break;
            case -1422568652:
		// add方法
                if (var10000.equals("add()V")) {
                    return 15;
                }
                break;
            case -1411783143:
                if (var10000.equals("CGLIB$hashCode$5()I")) {
                    return 13;
                }
                break;
            case -894172689:
                if (var10000.equals("newInstance(Lnet/sf/cglib/proxy/Callback;)Ljava/lang/Object;")) {
                    return 23;
                }
                break;
            case -623122092:
                if (var10000.equals("CGLIB$findMethodProxy(Lnet/sf/cglib/core/Signature;)Lnet/sf/cglib/proxy/MethodProxy;")) {
                    return 2;
                }
                break;
            case -508378822:
                if (var10000.equals("clone()Ljava/lang/Object;")) {
                    return 19;
                }
                break;
            case -419626537:
                if (var10000.equals("setCallbacks([Lnet/sf/cglib/proxy/Callback;)V")) {
                    return 3;
                }
                break;
            case -358764054:
                if (var10000.equals("delete()V")) {
                    return 24;
                }
                break;
            case 231902393:
                if (var10000.equals("CGLIB$delete$2()V")) {
                    return 10;
                }
                break;
            case 560567118:
                if (var10000.equals("setCallback(ILnet/sf/cglib/proxy/Callback;)V")) {
                    return 6;
                }
                break;
            case 780249084:
                if (var10000.equals("CGLIB$update$1()V")) {
                    return 9;
                }
                break;
            case 811063227:
                if (var10000.equals("newInstance([Ljava/lang/Class;[Ljava/lang/Object;[Lnet/sf/cglib/proxy/Callback;)Ljava/lang/Object;")) {
                    return 21;
                }
                break;
            case 973717575:
                if (var10000.equals("getCallbacks()[Lnet/sf/cglib/proxy/Callback;")) {
                    return 5;
                }
                break;
            case 1221173700:
                if (var10000.equals("newInstance([Lnet/sf/cglib/proxy/Callback;)Ljava/lang/Object;")) {
                    return 22;
                }
                break;
            case 1230699260:
                if (var10000.equals("getCallback(I)Lnet/sf/cglib/proxy/Callback;")) {
                    return 4;
                }
                break;
            case 1584330438:
                if (var10000.equals("CGLIB$SET_STATIC_CALLBACKS([Lnet/sf/cglib/proxy/Callback;)V")) {
                    return 0;
                }
                break;
            case 1729170762:
                if (var10000.equals("CGLIB$toString$4()Ljava/lang/String;")) {
                    return 12;
                }
                break;
            case 1826985398:
                if (var10000.equals("equals(Ljava/lang/Object;)Z")) {
                    return 16;
                }
                break;
            case 1913648695:
                if (var10000.equals("toString()Ljava/lang/String;")) {
                    return 17;
                }
                break;
            case 1984935277:
                if (var10000.equals("hashCode()I")) {
                    return 18;
                }
        }

        return -1;
    }

    public int getIndex(String var1, Class[] var2) {
        switch (var1.hashCode()) {
            case -1776922004:
                if (var1.equals("toString")) {
                    switch (var2.length) {
                        case 0:
                            return 17;
                    }
                }
                break;
            case -1335458389:
                if (var1.equals("delete")) {
                    switch (var2.length) {
                        case 0:
                            return 24;
                    }
                }
                break;
            case -1295482945:
                if (var1.equals("equals")) {
                    switch (var2.length) {
                        case 1:
                            if (var2[0].getName().equals("java.lang.Object")) {
                                return 16;
                            }
                    }
                }
                break;
            case -1053468136:
                if (var1.equals("getCallbacks")) {
                    switch (var2.length) {
                        case 0:
                            return 5;
                    }
                }
                break;
            case -838846263:
                if (var1.equals("update")) {
                    switch (var2.length) {
                        case 0:
                            return 20;
                    }
                }
                break;
            case -124978607:
                if (var1.equals("CGLIB$equals$3")) {
                    switch (var2.length) {
                        case 1:
                            if (var2[0].getName().equals("java.lang.Object")) {
                                return 11;
                            }
                    }
                }
                break;
            case -60403779:
                if (var1.equals("CGLIB$SET_STATIC_CALLBACKS")) {
                    switch (var2.length) {
                        case 1:
                            if (var2[0].getName().equals("[Lnet.sf.cglib.proxy.Callback;")) {
                                return 0;
                            }
                    }
                }
                break;
            case -29025553:
                if (var1.equals("CGLIB$hashCode$5")) {
                    switch (var2.length) {
                        case 0:
                            return 13;
                    }
                }
                break;
            case 96417:
                if (var1.equals("add")) {
                    switch (var2.length) {
                        case 0:
                            return 15;
                    }
                }
                break;
            case 85179481:
                if (var1.equals("CGLIB$SET_THREAD_CALLBACKS")) {
                    switch (var2.length) {
                        case 1:
                            if (var2[0].getName().equals("[Lnet.sf.cglib.proxy.Callback;")) {
                                return 1;
                            }
                    }
                }
                break;
            case 94756189:
                if (var1.equals("clone")) {
                    switch (var2.length) {
                        case 0:
                            return 19;
                    }
                }
                break;
            case 113325372:
                if (var1.equals("CGLIB$delete$2")) {
                    switch (var2.length) {
                        case 0:
                            return 10;
                    }
                }
                break;
            case 147696667:
                if (var1.equals("hashCode")) {
                    switch (var2.length) {
                        case 0:
                            return 18;
                    }
                }
                break;
            case 161998109:
                if (var1.equals("CGLIB$STATICHOOK1")) {
                    switch (var2.length) {
                        case 0:
                            return 7;
                    }
                }
                break;
            case 495524492:
                if (var1.equals("setCallbacks")) {
                    switch (var2.length) {
                        case 1:
                            if (var2[0].getName().equals("[Lnet.sf.cglib.proxy.Callback;")) {
                                return 3;
                            }
                    }
                }
                break;
            case 616208601:
                if (var1.equals("CGLIB$update$1")) {
                    switch (var2.length) {
                        case 0:
                            return 9;
                    }
                }
                break;
            case 1108311562:
                if (var1.equals("CGLIB$add$0")) {
                    switch (var2.length) {
                        case 0:
                            return 8;
                    }
                }
                break;
            case 1154623345:
                if (var1.equals("CGLIB$findMethodProxy")) {
                    switch (var2.length) {
                        case 1:
                            if (var2[0].getName().equals("net.sf.cglib.core.Signature")) {
                                return 2;
                            }
                    }
                }
                break;
            case 1543336191:
                if (var1.equals("CGLIB$toString$4")) {
                    switch (var2.length) {
                        case 0:
                            return 12;
                    }
                }
                break;
            case 1811874389:
                if (var1.equals("newInstance")) {
                    switch (var2.length) {
                        case 1:
                            String var10001 = var2[0].getName();
                            switch (var10001.hashCode()) {
                                case -845341380:
                                    if (var10001.equals("net.sf.cglib.proxy.Callback")) {
                                        return 23;
                                    }
                                    break;
                                case 1730110032:
                                    if (var10001.equals("[Lnet.sf.cglib.proxy.Callback;")) {
                                        return 22;
                                    }
                            }
                        case 2:
                        default:
                            break;
                        case 3:
                            if (var2[0].getName().equals("[Ljava.lang.Class;") && var2[1].getName().equals("[Ljava.lang.Object;") && var2[2].getName().equals("[Lnet.sf.cglib.proxy.Callback;")) {
                                return 21;
                            }
                    }
                }
                break;
            case 1817099975:
                if (var1.equals("setCallback")) {
                    switch (var2.length) {
                        case 2:
                            if (var2[0].getName().equals("int") && var2[1].getName().equals("net.sf.cglib.proxy.Callback")) {
                                return 6;
                            }
                    }
                }
                break;
            case 1905679803:
                if (var1.equals("getCallback")) {
                    switch (var2.length) {
                        case 1:
                            if (var2[0].getName().equals("int")) {
                                return 4;
                            }
                    }
                }
                break;
            case 1951977612:
                if (var1.equals("CGLIB$clone$6")) {
                    switch (var2.length) {
                        case 0:
                            return 14;
                    }
                }
        }

        return -1;
    }

    public int getIndex(Class[] var1) {
        switch (var1.length) {
            case 0:
                return 0;
            default:
                return -1;
        }
    }

    public Object invoke(int var1, Object var2, Object[] var3) throws InvocationTargetException {
        UserServiceImpl..EnhancerByCGLIB..7d030b4a var10000 = (UserServiceImpl..EnhancerByCGLIB..7d030b4a)var2;
        int var10001 = var1;

        try {
            switch (var10001) {
                case 0:
                    7d030b4a.CGLIB$SET_STATIC_CALLBACKS((Callback[])var3[0]);
                    return null;
                case 1:
                    7d030b4a.CGLIB$SET_THREAD_CALLBACKS((Callback[])var3[0]);
                    return null;
                case 2:
                    return 7d030b4a.CGLIB$findMethodProxy((Signature)var3[0]);
                case 3:
                    var10000.setCallbacks((Callback[])var3[0]);
                    return null;
                case 4:
                    return var10000.getCallback(((Number)var3[0]).intValue());
                case 5:
                    return var10000.getCallbacks();
                case 6:
                    var10000.setCallback(((Number)var3[0]).intValue(), (Callback)var3[1]);
                    return null;
                case 7:
                    7d030b4a.CGLIB$STATICHOOK1();
                    return null;
                case 8:
                    var10000.CGLIB$add$0();
                    return null;
                case 9:
                    var10000.CGLIB$update$1();
                    return null;
                case 10:
                    var10000.CGLIB$delete$2();
                    return null;
                case 11:
                    return new Boolean(var10000.CGLIB$equals$3(var3[0]));
                case 12:
                    return var10000.CGLIB$toString$4();
                case 13:
                    return new Integer(var10000.CGLIB$hashCode$5());
                case 14:
                    return var10000.CGLIB$clone$6();
                case 15:
		    // 15对应的是 add方法
                    var10000.add();
                    return null;
                case 16:
                    return new Boolean(var10000.equals(var3[0]));
                case 17:
                    return var10000.toString();
                case 18:
                    return new Integer(var10000.hashCode());
                case 19:
                    return var10000.clone();
                case 20:
                    var10000.update();
                    return null;
                case 21:
                    return var10000.newInstance((Class[])var3[0], (Object[])var3[1], (Callback[])var3[2]);
                case 22:
                    return var10000.newInstance((Callback[])var3[0]);
                case 23:
                    return var10000.newInstance((Callback)var3[0]);
                case 24:
                    var10000.delete();
                    return null;
            }
        } catch (Throwable var4) {
            throw new InvocationTargetException(var4);
        }

        throw new IllegalArgumentException("Cannot find matching method/constructor");
    }

    public Object newInstance(int var1, Object[] var2) throws InvocationTargetException {
        UserServiceImpl..EnhancerByCGLIB..7d030b4a var10000 = new UserServiceImpl..EnhancerByCGLIB..7d030b4a;
        UserServiceImpl..EnhancerByCGLIB..7d030b4a var10001 = var10000;
        int var10002 = var1;

        try {
            switch (var10002) {
                case 0:
                    var10001.<init>();
                    return var10000;
            }
        } catch (Throwable var3) {
            throw new InvocationTargetException(var3);
        }

        throw new IllegalArgumentException("Cannot find matching method/constructor");
    }

    public int getMaxIndex() {
        return 24;
    }
}
```
 综上所述，调用顺序依次是：
代理类add—>自定义方法拦截器CustomInvocationHandlerd的invoke()方法—>代理类索引类UserServiceImpl$$EnhancerByCGLIB$$7d030b4a$$FastClassByCGLIB$$46fa6803的getIndex()方法–>代理类索引类UserServiceImpl$$EnhancerByCGLIB$$7d030b4a$$FastClassByCGLIB$$46fa6803的invoke()方法—>代理类的CGLIB$add$0方法—>被代理类UserServiceImpl的add()方法
